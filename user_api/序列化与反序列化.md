### 序列化与反序列化

### json 序列化
- 序列化: python 对象 转 json
- 反序列化: json  转 python 对象


```python

import json

computer = {
    "control_plane": 5000,
    "screen": 1000,
    "keyboard": 60,
    "mouse": 150
}

#json.dumps 是将python对象转换为 json格式
computer_obj = json.dumps(computer)
print(computer_obj)
print(type(computer_obj))
"""
{"control_plane": 5000, "screen": 1000, "keyboard": 60, "mouse": 150}
<class 'str'>
"""


#json.loads 是将json格式转换为 python对象
json_obj = json.loads(computer_obj)
print(json_obj)
print(type(json_obj))

"""
{'control_plane': 5000, 'screen': 1000, 'keyboard': 60, 'mouse': 150}
<class 'dict'>
"""
```

### serializers 序列化

serializers 是django内置的一个序列化器,可以直接将Queryset 对象转为json格式,不支持反序列化
```python
from django.core import serializers
from myapp.models import User
u=User.objects.all()
data = serializers.serialize('json',u)
print(data)
#'[{"model": "myapp.user", "pk": 1, "fields": {"user": "aliang", "name": "阿良", "sex": "男", "age": 32, "label": "运动员,裁判", "create_time": "2024-09-18T20:05:18.686", "update_time": "2024-09-18T20:05:18.686"}}, {"model": "myapp.user", "pk": 2, "fields": {"user": "阿三", "name": "张三", "sex": "男", "age": 41, "label": "司机,乒乓球运动员", "create_time": "2024-09-18T20:06:16.836", "update_time": "2024-09-18T20:06:16.836"}}, {"model": "myapp.user", "pk": 3, "fields": {"user": "阿呷", "name": "阿呷", "sex": "男", "age": 92, "label": "互联网工程师,蓝球运动员", "create_time": "2024-09-18T20:07:01.981", "update_time": "2024-09-18T20:07:01.981"}}, {"model": "myapp.user", "pk": 4, "fields": {"user": "阿四", "name": "张四", "sex": "男", "age": 40, "label": "足球运动员", "create_time": "2024-09-18T20:51:03.178", "update_time": "2024-09-18T20:51:03.178"}}]'

print(type(data))
#<class 'str'>

```

### 

```python

from django.http import JsonResponse
computer = {
    "control_plane": 5000,
    "screen": 1000,
    "keyboard": 60,
    "mouse": 150
}

t = JsonResponse(computer)
print(t)
#<JsonResponse status_code=200, "application/json">
print(type(t))
#<class 'django.http.response.JsonResponse'>

```

### DRF序列器

DRF的 serializers 模块专门负责数据序列化,DRF提供的方案更先进,更高级别的序列化方案
序列化器支持的三种类型:
- Serializer: 对Model(数据模型)进行序列化,需要自定义字段映射
- ModelSerializer: 对Model进行序列化,会自动生成字段和验证规则,默认还包含简单的create和update()方法
- HyperlinkedModelSerializer: 与ModelSerializer类似,只不过使用超链接来表示关系而不是主键id

使用DRF的序列化器,先创建Model数据模型,创建序列化器,创建视图,创建路径规则

Model数据模型
```python
from django.db import models

# Create your models here.
class User(models.Model):
    name = models.CharField(max_length=100)
    age = models.IntegerField()
    sex = models.CharField(max_length=100)
    city = models.CharField(max_length=100)
```

序列化器
```python
from user_api.models import User
from rest_framework import serializers

class UserSerializer(serializers.Serializer):
    name = serializers.CharField(max_length=100)
    city = serializers.CharField(max_length=100)
    email = serializers.EmailField(max_length=100)
    age = serializers.CharField(max_length=100)
```

视图编写
```python
from rest_framework import status
from rest_framework.response import Response

from .serializers import UserSerializer
from rest_framework.views import APIView

class UserviewAPIView(APIView):
    def get(self, request):
        serializer = UserSerializer(request.user)
        return Response(serializer.data)
    def post(self, request):
        serializer = UserSerializer(data=request.data)
        return Response(serializer.data, status=status.HTTP_201_CREATED)
    def put(self, request):
        serializer = UserSerializer(request.user, data=request.data)
        return Response(serializer.data)
    def delete(self, request):
        serializer = UserSerializer(request.user)
        return Response(serializer.data)
```

路由编写
```python
from rest_framework import status
from rest_framework.response import Response

from .serializers import UserSerializer
from rest_framework.views import APIView
urlpatterns = [
    path('api/user/', UserviewAPIView.as_view(),name='user'),
    re_path('^api/user/(?P<pk>\d+)/?$', UserviewAPIView.as_view(),name='user'),
]
```

视图中使用序列化器
```python
from article.models import User
from .serializers import UserSerializer
from rest_framework.response import Response
queryset = User.objects.all()
serializer = UserSerializer(queryset, many=True)

#序列化器
print(serializer)

#从.data属性获取序列化结果
print(serializer.data)

#返回序列化结果
return Response(serializer.data)
'''
UserSerializer(<QuerySet [<User: admin>]>, many=True):
    name = CharField(max_length=100)
    city = CharField(max_length=100)
    email = EmailField(max_length=100)
    age = CharField(max_length=100)
'''

'''
[{'name': '张三', 'city': '北京', 'age': '15', 'sex': '男'}, {'name': '李四', 'city': '上海', 'age': '25', 'sex': '男'}]
'''
'''
[
    {
        "name": "张三",
        "city": "北京",
        "age": "15",
        "sex": "男"
    },
    {
        "name": "李四",
        "city": "上海",
        "age": "25",
        "sex": "男"
    }
]
'''
```

restful api 风格是
查多: `/api/user` 获取所有数据
创建: `/api/user` 创建数据
查单: `/api/user/1` 查询单个数据
更新: `/api/user/1` 更新单个数据
删除: `/api/user/1` 删除单个数据

### 查多,查单
序列化器
```python
from user_api.models import User
from rest_framework import serializers

class UserSerializer(serializers.Serializer):
    id = serializers.CharField(max_length=100)
    name = serializers.CharField(max_length=100)
    city = serializers.CharField(max_length=100)
    age = serializers.CharField(max_length=100)
    sex = serializers.CharField(max_length=100)
```

视图
```python
from rest_framework.response import Response

from .serializers import UserSerializer
from rest_framework.views import APIView
from user_api.models import User
    def get(self, request,pk=None):
        if pk is None:
            # serializer = UserSerializer(request.user)
            # return Response(serializer.data)
            queryset = User.objects.all()
            serializer = UserSerializer(queryset, many=True)
            print(serializer)
            print(serializer.data)
        else:
            queryset = User.objects.get(pk=pk)
            serializer = UserSerializer(queryset)
            print(serializer)
            print(serializer.data)

        return Response(serializer.data)
```

### 新建数据

路由
```python
from django.urls import path,re_path,include
from user_api.views import UserviewAPIView

urlpatterns = [
path('api/user/', UserviewAPIView.as_view(),name='user'),
re_path('^api/user/(?P<pk>\d+)/?$', UserviewAPIView.as_view(),name='user'),
]
```

视图
```python
from rest_framework.response import Response

from .serializers import UserSerializer
from rest_framework.views import APIView
from user_api.models import User

def post(self, request):
    #获取post数据
    data= request.data
    # 调用序列化器将提交的数据进行反序列化
    serializer = UserSerializer(data=data)
    if serializer.is_valid():
        #调用重写的create方法
        serializer.save()
        msg = "ok"
        code=200
    else:
        msg=serializer.errors
        code=400
    response={'msg':msg,'code':code}
    return Response(response)
```

序列化器
```python
from user_api.models import User
from rest_framework import serializers

class UserSerializer(serializers.Serializer):
    id = serializers.CharField(max_length=100)
    name = serializers.CharField(max_length=100)
    city = serializers.CharField(max_length=100)
    age = serializers.CharField(max_length=100)
    sex = serializers.CharField(max_length=100)
    
    #重写create()方法,实现数据入库
    def create(self, validated_data):
        # validated_data 反序列化后的数据
        return User.objects.create(**validated_data)
```

### 更新数据

路由
```python
from django.urls import path,re_path,include
from user_api.views import UserviewAPIView

urlpatterns = [
path('api/user/', UserviewAPIView.as_view(),name='user'),
re_path('^api/user/(?P<pk>\d+)/?$', UserviewAPIView.as_view(),name='user'),
]
```

视图
```python
from rest_framework.response import Response

from .serializers import UserSerializer
from rest_framework.views import APIView
from user_api.models import User

def put(self, request,pk=None):
    # 获取json数据
    data= request.data
    # 获取主键对象
    user = User.objects.get(pk=pk)
    # 调用序列化器将提交的数据进行反序列化
    serializer = UserSerializer(instance=user,data=data)
    if serializer.is_valid():
        # 调用 update方法
        serializer.save()
        msg = "ok"
        code=200
    else:
        msg=serializer.errors
        code=400
    response={'msg':msg,'code':code}
    return Response(response)
```

序列化器
```python
from user_api.models import User
from rest_framework import serializers

class UserSerializer(serializers.Serializer):
    id = serializers.CharField(max_length=100)
    name = serializers.CharField(max_length=100)
    city = serializers.CharField(max_length=100)
    age = serializers.CharField(max_length=100)
    sex = serializers.CharField(max_length=100)

    # 重写update()方法,实现数据更新
    def update(self, instance, validated_data):
        # instance是当前操作对象,validated_data是反序列化后的结果
        instance.name = validated_data.get('name', instance.name)
        instance.city = validated_data.get('city', instance.city)
        instance.age = validated_data.get('age', instance.age)
        instance.sex = validated_data.get('sex', instance.sex)
        instance.save()
        return instance
```

### 删除数据

路由
```python
from django.urls import path,re_path,include
from user_api.views import UserviewAPIView

urlpatterns = [
path('api/user/', UserviewAPIView.as_view(),name='user'),
re_path('^api/user/(?P<pk>\d+)/?$', UserviewAPIView.as_view(),name='user'),
]
```

视图
```python
from rest_framework.response import Response

from .serializers import UserSerializer
from rest_framework.views import APIView
from user_api.models import User

def delete(self, request,pk=None):
    try:
        User.objects.get(id=pk).delete()
        msg = "ok"
        code=200
    except Exception as e:
        msg=str(e)
        code=400
    response={'msg':msg,'code':code}
    return Response(response)
```
